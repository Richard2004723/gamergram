<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamerGram - Share Your Wins</title>

    <!-- 
      DELETED the old script tag: <script src="https://cdn.tailwindcss.com"></script>
      ADDED the new link to your local, compiled CSS file below.
    -->
    <link href="./dist/output.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-black text-slate-200 min-h-screen antialiased">

    <div id="notification-container" class="fixed top-5 right-5 z-[100]"></div>

    <div class="min-h-screen md:flex">

        <aside id="sidebar" class="hidden md:flex w-72 flex-col p-5 gap-6 border-r border-slate-800/50 bg-black">
            <div class="flex items-center gap-3">
                <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-black text-lg font-bold">G</div>
                <div><h1 class="text-xl font-semibold">GamerGram</h1></div>
            </div>

            <nav aria-label="Main Navigation" class="flex-1">
                <ul class="flex flex-col gap-2">
                    <li><a href="#home" data-page="home" class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Home</span></a></li>
                    <li><a href="#explore" data-page="explore" class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span>Explore</span></a></li>
                    <li><a href="#upload" data-page="upload" class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><span>Create Post</span></a></li>
                    <li><a href="#profile" data-page="profile" class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span id="sidebar-profile-link">Profile</span></a></li>
                </ul>
            </nav>

            <div class="mt-auto space-y-2">
                 <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-500/10 text-red-400">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" stroke-width="1.5"></path></svg>
                    <span>Log Out</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-black">
            <div class="flex-1 overflow-auto md:p-4">
                <section id="page-home" class="page-content active space-y-6 max-w-xl mx-auto p-4">
                    <h2 class="text-2xl font-bold">Home Feed</h2>
                    <div id="feed-container" class="space-y-8">
                         <p class="text-center text-slate-400">Loading posts...</p>
                    </div>
                </section>
                <section id="page-explore" class="page-content hidden space-y-6 max-w-4xl mx-auto p-4">
                    <h2 class="text-2xl font-bold">Explore Users</h2>
                    <div id="explore-users-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <p class="text-slate-400">Loading users...</p>
                    </div>
                </section>
                <section id="page-upload" class="page-content hidden space-y-6 max-w-2xl mx-auto p-4">
                    <h2 class="text-2xl font-bold">Create Post</h2>
                    <div class="bg-[#1a1a1a] p-4 md:p-6 rounded-xl">
                        <form id="create-post-form" class="space-y-4">
                            <label class="block"><span class="text-sm text-slate-300">Caption</span>
                                <input id="post-caption" type="text" placeholder="Your amazing gaming moment..." class="mt-1 block w-full rounded-md bg-transparent outline-none px-3 py-2 border border-slate-700 focus:border-purple-500" required />
                            </label>
                            <label class="block"><span class="text-sm text-slate-300">Tags</span>
                                <input id="post-tags" type="text" placeholder="#Valorant #Clutch" class="mt-1 block w-full rounded-md bg-transparent outline-none px-3 py-2 border border-slate-700 focus:border-purple-500" />
                            </label>
                            <label class="block"><span class="text-sm text-slate-300">Media (Image)</span>
                                <input id="post-image-upload" type="file" accept="image/*" class="mt-1 block w-full text-sm" required />
                            </label>
                            <div id="post-image-preview-container" class="rounded-md overflow-hidden bg-black/30 aspect-[16/9] flex items-center justify-center text-slate-400">Preview will appear here</div>
                            <div class="flex items-center justify-between pt-2">
                                <button type="button" id="cancel-upload-btn" class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 font-semibold">Cancel</button>
                                <button type="submit" id="submit-post-btn" class="px-4 py-2 rounded-md bg-purple-500 text-white font-semibold">Post</button>
                            </div>
                        </form>
                    </div>
                </section>
                <section id="page-profile" class="page-content hidden">
                    <div id="profile-container" class="max-w-4xl mx-auto"><p class="text-slate-400 p-4">Loading profile...</p></div>
                </section>
            </div>

            <nav class="md:hidden sticky bottom-0 left-0 w-full z-30 bg-black border-t border-slate-800">
                <div class="flex items-center justify-around p-2">
                    <a href="#home" data-page="home" class="nav-link mobile-nav p-3 rounded-full"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a>
                    <a href="#explore" data-page="explore" class="nav-link mobile-nav p-3 rounded-full"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></a>
                    <a href="#upload" data-page="upload" class="nav-link mobile-nav p-3 rounded-full"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></a>
                    <a href="#profile" data-page="profile" class="nav-link mobile-nav p-1.5 rounded-full">
                        <img id="nav-profile-pic" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="w-8 h-8 rounded-full object-cover">
                    </a>
                </div>
            </nav>
        </main>
    </div>

    <div id="settings-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-black p-6 md:p-8 rounded-xl border border-slate-800/50 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Settings</h2><button id="close-settings-btn" class="text-slate-400 hover:text-white text-3xl">&times;</button></div>
            <form id="settings-form" class="space-y-4">
                <h3 class="text-lg font-semibold text-purple-400 border-b border-slate-700 pb-2">Profile</h3>
                <div class="pt-4 flex flex-col items-center">
                    <label for="settings-pfp-upload" class="cursor-pointer"><img id="settings-pfp-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Profile picture preview" class="w-24 h-24 rounded-full object-cover border-2 border-slate-600"></label>
                    <input type="file" id="settings-pfp-upload" class="hidden" accept="image/*">
                    <p class="text-xs text-slate-400 mt-2">Click image to change</p>
                </div>
                <div><label for="settings-username" class="block text-sm font-medium text-slate-300 mb-1">Username</label><input type="text" id="settings-username" class="w-full bg-transparent border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-purple-500"></div>
                <div><label for="settings-bio" class="block text-sm font-medium text-slate-300 mb-1">Bio</label><textarea id="settings-bio" class="w-full bg-transparent border border-slate-700 rounded-lg p-3 h-24 focus:outline-none focus:border-purple-500"></textarea></div>
                <div class="flex justify-end pt-2"><button type="submit" class="px-4 py-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white font-semibold">Save Profile</button></div>
                <h3 class="text-lg font-semibold text-purple-400 border-b border-slate-700 pb-2 pt-6">Account</h3>
                <div class="pt-2"><button type="button" id="reset-password-btn" class="text-sm text-purple-400/80 hover:underline">Send Password Reset Email</button><p id="reset-feedback" class="text-sm mt-2"></p></div>
            </form>
        </div>
    </div>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Firebase Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyB2aJP1_9HA05T-F7ibtUh29XWAHRmCCdg",
      authDomain: "gamergram-9a855.firebaseapp.com",
      projectId: "gamergram-9a855",
      storageBucket: "gamergram-9a855.appspot.com",
      messagingSenderId: "225075637418",
      appId: "1:225075637418:web:9d094d12fd811e21cf74d3",
      measurementId: "G-0Y9L8CHJFQ"
    };
    const appId = 'gamergram-app';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- State Variables ---
    let currentUser = null;
    let currentUserProfile = null;
    let postsUnsubscribe = null;
    let selectedPostFile = null;
    let selectedPfpFile = null;

    // --- DOM Elements ---
    const settingsModal = document.getElementById('settings-modal');
    const pages = document.querySelectorAll('.page-content');
    const navLinks = document.querySelectorAll('.nav-link');

    // --- Utility Functions ---
    function showNotification(message, isError = false) {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.textContent = message;
        notif.className = `p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        container.appendChild(notif);
        setTimeout(() => { notif.remove() }, 3000);
    }
    const closeAllModals = () => settingsModal.classList.add('modal-hidden');

    // --- Auth & App Initialization ---
    onAuthStateChanged(auth, async user => {
        if (user && !user.isAnonymous) {
            currentUser = user;
            await fetchUserProfile(user.uid, true);
            document.querySelector('#sidebar')?.classList.remove('hidden');
            handleHashChange();
        } else {
            window.location.href = './auth.html';
        }
    });

    async function fetchUserProfile(userId, isCurrentUser = false) {
        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, userId);
        const docSnap = await getDoc(userDocRef);
        if (!docSnap.exists()) return null;

        const profileData = { id: docSnap.id, ...docSnap.data() };
        if (isCurrentUser) {
            currentUserProfile = profileData;
            document.getElementById('sidebar-profile-link').textContent = currentUserProfile.username;
            document.getElementById('nav-profile-pic').src = profileData.photoURL || `https://ui-avatars.com/api/?name=${profileData.username.charAt(0)}&background=A78BFA&color=000`;
        }
        return profileData;
    }

    async function fetchUserProfileByUsername(username) {
        const q = query(collection(db, `/artifacts/${appId}/public/data/users`), where("username", "==", username));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            const userDoc = querySnapshot.docs[0];
            return { id: userDoc.id, ...userDoc.data() };
        }
        return null;
    }

    // --- SPA Navigation ---
    function showPage(pageId) {
        pages.forEach(page => {
            page.classList.toggle('active', page.id === `page-${pageId}`);
            page.classList.toggle('hidden', page.id !== `page-${pageId}`);
        });
        window.scrollTo(0, 0);
        navLinks.forEach(link => {
            const isMobile = link.classList.contains('mobile-nav');
            const activeClass = isMobile ? 'mobile-nav-active' : 'nav-active';
            link.classList.toggle(activeClass, link.dataset.page === pageId);
        });
    }

    function handleHashChange() {
        const hash = window.location.hash.substring(1) || 'home';
        let [pageId, param] = hash.split('=');
        
        const profileLinks = Array.from(document.querySelectorAll('.nav-link[data-page="profile"]'));
        if(profileLinks.length > 0 && currentUserProfile) profileLinks.forEach(l => l.href = `#profile=${currentUserProfile.username}`);

        showPage(pageId);
        
        switch (pageId) {
            case 'home': listenForPosts(); break;
            case 'explore': loadExplorePage(); break;
            case 'profile': loadProfilePage(param || currentUserProfile.username); break;
        }
    }
    window.addEventListener('hashchange', handleHashChange);
    
    // --- Feed Logic ---
    function listenForPosts() {
        if (postsUnsubscribe) postsUnsubscribe();
        const q = query(collection(db, `/artifacts/${appId}/public/data/posts`));
        
        postsUnsubscribe = onSnapshot(q, async (snapshot) => {
            const blockedUsers = currentUserProfile?.blockedUsers || [];
            const postPromises = snapshot.docs
                .filter(doc => !blockedUsers.includes(doc.data().userId))
                .map(async postDoc => {
                    const post = { id: postDoc.id, ...postDoc.data() };
                    const userSnap = await getDoc(doc(db, `/artifacts/${appId}/public/data/users`, post.userId));
                    if (userSnap.exists() && !userSnap.data().isBanned) {
                        post.authorPhotoURL = userSnap.data().photoURL;
                        return post;
                    }
                    return null;
                });
            const posts = (await Promise.all(postPromises)).filter(Boolean);
            renderFeed(posts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()));
        });
    }
    
    function renderFeed(posts) {
        const feedContainer = document.getElementById('feed-container');
        if (!feedContainer) return;
        if (posts.length === 0) {
            feedContainer.innerHTML = '<p class="text-center text-slate-400">No posts yet. Follow users or create a post!</p>';
            return;
        }
        feedContainer.innerHTML = posts.map(post => {
            const isLiked = post.likes.includes(currentUser.uid);
            return `
            <article class="bg-[#1a1a1a] rounded-xl overflow-hidden border border-slate-800">
                <header class="p-4 flex items-center space-x-3">
                    <a href="#profile=${post.username}"><img src="${post.authorPhotoURL || `https://ui-avatars.com/api/?name=${post.username.charAt(0)}&background=A78BFA&color=000`}" class="w-10 h-10 rounded-full object-cover" alt="${post.username}'s avatar"></a>
                    <a href="#profile=${post.username}" class="font-semibold text-white hover:underline">${post.username}</a>
                </header>
                <img src="${post.imageUrl}" alt="Post image by ${post.username}" class="w-full bg-black">
                <div class="p-4">
                    <div class="flex items-center space-x-4">
                       <button class="like-btn" data-post-id="${post.id}">
                            <svg class="w-6 h-6 ${isLiked ? 'text-red-500' : 'text-white'}" xmlns="http://www.w3.org/2000/svg" fill="${isLiked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                        </button>
                        <span class="text-white">${post.likes.length} Likes</span>
                    </div>
                    <p class="text-slate-300 mt-2"><a href="#profile=${post.username}" class="font-semibold text-white hover:underline">${post.username}</a> ${post.caption}</p>
                </div>
            </article>`;
        }).join('');
    }

    // --- Explore Page ---
    async function loadExplorePage() {
        const grid = document.getElementById('explore-users-grid');
        grid.innerHTML = '<p class="text-slate-400">Loading users...</p>';
        const usersRef = collection(db, `/artifacts/${appId}/public/data/users`);
        const q = query(usersRef, where("isBanned", "==", false));
        const querySnapshot = await getDocs(q);
        const blockedUsers = currentUserProfile.blockedUsers || [];
        const usersHtml = querySnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(user => user.id !== currentUser.uid && !blockedUsers.includes(user.id))
            .map(user => `
                <a href="#profile=${user.username}" class="block bg-[#1a1a1a] border border-slate-800 p-4 rounded-xl text-center hover:border-purple-500 transition">
                    <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.username.charAt(0)}&background=A78BFA&color=000`}" class="w-20 h-20 rounded-full mx-auto object-cover">
                    <p class="mt-2 font-semibold truncate">${user.username}</p>
                </a>`).join('');
        grid.innerHTML = usersHtml || '<p class="text-slate-400 col-span-full text-center">No other users to show.</p>';
    }
    
    // --- Create Post Logic ---
    document.getElementById('post-image-upload')?.addEventListener('change', e => {
        const file = e.target.files && e.target.files[0];
        const preview = document.getElementById('post-image-preview-container');
        if (file) {
            selectedPostFile = file;
            preview.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="preview" class="object-cover w-full h-full"/>`;
        }
    });
    document.getElementById('create-post-form')?.addEventListener('submit', async (e) => {
         e.preventDefault();
         if (!selectedPostFile) { showNotification("Please select an image.", true); return; }
         const submitBtn = document.getElementById('submit-post-btn');
         submitBtn.disabled = true;
         submitBtn.textContent = 'Uploading...';
         try {
            const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${selectedPostFile.name}`);
            const snapshot = await uploadBytes(storageRef, selectedPostFile);
            const downloadURL = await getDownloadURL(snapshot.ref);
            await addDoc(collection(db, `/artifacts/${appId}/public/data/posts`), {
                userId: currentUser.uid, username: currentUserProfile.username,
                caption: document.getElementById('post-caption').value,
                tags: document.getElementById('post-tags').value,
                imageUrl: downloadURL,
                likes: [], comments: [], createdAt: new Date()
            });
            e.target.reset();
            document.getElementById('post-image-preview-container').innerHTML = 'Preview will appear here';
            selectedPostFile = null;
            showNotification("Post created successfully!");
            window.location.hash = 'home';
         } catch (error) {
            showNotification("Failed to create post.", true);
         } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Post';
         }
    });

    // --- Profile Page ---
    async function loadProfilePage(username) {
         const profileContainer = document.getElementById('profile-container');
         profileContainer.innerHTML = `<p class="text-slate-400 p-4">Loading profile...</p>`;
         const profileUser = await fetchUserProfileByUsername(username);
         if (!profileUser) {
             profileContainer.innerHTML = `<p class="text-red-500 p-4">User not found.</p>`; return;
         }
         const postsQuery = query(collection(db, `/artifacts/${appId}/public/data/posts`), where("userId", "==", profileUser.id));
         const postsSnapshot = await getDocs(postsQuery);
         const userPosts = postsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
         const isOwnProfile = profileUser.id === currentUser.uid;
         const isFollowing = currentUserProfile?.following?.includes(profileUser.id);
         profileContainer.innerHTML = `
            <div class="p-4 border-b border-slate-800">
                <header class="flex justify-between items-center mb-4">
                    <a href="#home" class="nav-link text-xl p-2">&larr;</a><h1 class="text-xl font-bold">${profileUser.username}</h1>
                    <button class="p-2 ${isOwnProfile ? 'open-settings-btn' : 'user-options-btn'}"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2m0-6c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2m0 12c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2"/></svg></button>
                </header>
                <div class="flex items-center">
                    <img src="${profileUser.photoURL || `https://ui-avatars.com/api/?name=${profileUser.username.charAt(0)}&background=A78BFA&color=000`}" class="w-20 h-20 md:w-24 md:h-24 rounded-full object-cover mr-4">
                    <div class="flex-1 flex justify-around text-center">
                        <div><span class="font-bold text-lg">${userPosts.length}</span><p class="text-sm text-slate-400">Posts</p></div>
                        <div><span class="font-bold text-lg">${profileUser.followers?.length || 0}</span><p class="text-sm text-slate-400">Followers</p></div>
                        <div><span class="font-bold text-lg">${profileUser.following?.length || 0}</span><p class="text-sm text-slate-400">Following</p></div>
                    </div>
                </div>
                <div class="mt-4"><p class="font-semibold">${profileUser.fullName || profileUser.username}</p><p class="text-sm text-slate-300 whitespace-pre-wrap">${profileUser.bio || 'No bio yet.'}</p></div>
                <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
                    ${isOwnProfile 
                        ? `<button class="open-settings-btn w-full bg-slate-800 hover:bg-slate-700 font-semibold py-2 rounded-lg">Edit Profile</button><button class="w-full bg-slate-800 hover:bg-slate-700 font-semibold py-2 rounded-lg">Share Profile</button>`
                        : `<button id="follow-btn" data-user-id="${profileUser.id}" class="w-full ${isFollowing ? 'bg-slate-800' : 'bg-blue-500'} hover:bg-slate-700 font-semibold py-2 rounded-lg">${isFollowing ? 'Following' : 'Follow'}</button><button id="block-user-btn" data-user-id="${profileUser.id}" class="w-full bg-red-800/50 hover:bg-red-800/80 font-semibold py-2 rounded-lg">Block</button>`
                    }
                </div>
            </div>
            <div class="border-t border-slate-800"><div class="grid grid-cols-3 gap-0.5">
                ${userPosts.length > 0 ? userPosts.map(post => `<div class="aspect-square bg-slate-800"><img src="${post.imageUrl}" class="w-full h-full object-cover"></div>`).join('') : '<p class="text-slate-400 col-span-3 text-center p-8">No posts yet.</p>'}
            </div></div>`;
    }
    
    // --- Social Actions ---
    async function followUser(targetUserId) {
        const batch = writeBatch(db);
        const currentUserRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
        const targetUserRef = doc(db, `/artifacts/${appId}/public/data/users`, targetUserId);
        const isFollowing = currentUserProfile.following?.includes(targetUserId);
        if (isFollowing) {
            batch.update(currentUserRef, { following: arrayRemove(targetUserId) });
            batch.update(targetUserRef, { followers: arrayRemove(currentUser.uid) });
        } else {
            batch.update(currentUserRef, { following: arrayUnion(targetUserId) });
            batch.update(targetUserRef, { followers: arrayUnion(currentUser.uid) });
        }
        await batch.commit();
        await fetchUserProfile(currentUser.uid, true);
        loadProfilePage((await getDoc(targetUserRef)).data().username);
    }
    async function blockUser(targetUserId) {
        const currentUserRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
        await updateDoc(currentUserRef, { blockedUsers: arrayUnion(targetUserId) });
        await fetchUserProfile(currentUser.uid, true);
        window.location.hash = 'home';
    }

    // --- Settings Modal ---
    function openSettingsModal() {
        if (!currentUserProfile) return;
        document.getElementById('settings-username').value = currentUserProfile.username;
        document.getElementById('settings-bio').value = currentUserProfile.bio || '';
        document.getElementById('settings-pfp-preview').src = currentUserProfile.photoURL || `https://ui-avatars.com/api/?name=${currentUserProfile.username.charAt(0)}&background=A78BFA&color=000`;
        selectedPfpFile = null;
        settingsModal.classList.remove('modal-hidden');
    }
    document.getElementById('settings-pfp-upload').addEventListener('change', e => {
        const file = e.target.files?.[0];
        if(file) {
            selectedPfpFile = file;
            document.getElementById('settings-pfp-preview').src = URL.createObjectURL(file);
        }
    });
    document.getElementById('settings-form').addEventListener('submit', async e => {
        e.preventDefault();
        const newUsername = document.getElementById('settings-username').value;
        const newBio = document.getElementById('settings-bio').value;
        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
        const updatedData = { username: newUsername, bio: newBio };
        if (selectedPfpFile) {
            const storageRef = ref(storage, `profile-pictures/${currentUser.uid}/${selectedPfpFile.name}`);
            const snapshot = await uploadBytes(storageRef, selectedPfpFile);
            updatedData.photoURL = await getDownloadURL(snapshot.ref);
        }
        await updateDoc(userDocRef, updatedData);
        await fetchUserProfile(currentUser.uid, true);
        closeAllModals();
        loadProfilePage(newUsername);
        showNotification("Profile updated successfully!");
    });

    // --- Master Event Listener ---
    document.body.addEventListener('click', async (e) => {
        // Handle Navigation Links
        const navLink = e.target.closest('a.nav-link');
        if (navLink) {
            e.preventDefault();
            window.location.hash = navLink.getAttribute('href');
            return;
        }

        // Handle Buttons
        const button = e.target.closest('button');
        if (!button) return;

        // Modal & Menu Buttons
        if (button.classList.contains('open-settings-btn')) { openSettingsModal(); return; }
        if (button.id === 'close-settings-btn') { closeAllModals(); return; }
        if (button.id === 'logout-btn') { signOut(auth); return; }

        // Social Action Buttons
        if (button.id === 'follow-btn') { await followUser(button.dataset.userId); return; }
        if (button.id === 'block-user-btn') { if(confirm('Are you sure you want to block this user?')) await blockUser(button.dataset.userId); return; }
        
        if (button.classList.contains('like-btn')) {
            const postId = button.dataset.postId;
            const postRef = doc(db, `/artifacts/${appId}/public/data/posts`, postId);
            const isLiked = button.querySelector('svg').classList.contains('text-red-500');
            await updateDoc(postRef, { likes: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
        }
    });
</script>
</body>
</html>
